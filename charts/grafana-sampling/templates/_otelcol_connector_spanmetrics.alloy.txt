{{- define "statefulset.connector.spanmetrics" -}}
otelcol.connector.spanmetrics "default" {
  // https://grafana.com/docs/alloy/latest/reference/components/otelcol.connector.spanmetrics/
  {{- range $.Values.metricsGeneration.dimensions }}
  dimension {
    name = {{ . | quote }}
  }
  {{- end }}

  resource_metrics_key_attributes = [
    "service.name",
    "span.name",
    "span.kind",
    "status.code",
    {{- range $.Values.metricsGeneration.dimensions }}
    {{ . | quote }},
    {{- end }}
  ]

  {{ if .Values.metricsGeneration.legacy }}
  namespace = "traces.spanmetrics"
  {{- end }}

  metrics_expiration = {{ .Values.metricsGeneration.expiration }}
  metrics_flush_interval = {{ .Values.metricsGeneration.flushInterval }}

  histogram {
    unit = "s"

    explicit {
      buckets = [{{- join ", " .Values.metricsGeneration.buckets }}]
    }
  }

  output {
    metrics = [otelcol.processor.filter.drop_unneeded_span_metrics.input]
  }
}


{{ end }}
